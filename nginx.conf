worker_processes auto;

events {
  worker_connections 4096;
}

http {
  resolver 8.8.8.8 valid=300s;

  server {
    listen 80;
    server_name _;

    # ===============================
    # /secure/<token>/<start>/<end>/<file>
    # ===============================
    location ~ ^/secure/([^/]+)/(\d+)/(\d+)/(.*)$ {

      set $token   $1;
      set $start   $2;
      set $end     $3;
      set $file    $4;

      # Expiry check
      if ($end < $time_epoch) {
        return 410;
      }

      # IP-LOCK + TIME TOKEN
      secure_link $token,$end;
      secure_link_md5 "$end$file$remote_addr my_secret_key";

      if ($secure_link = "") { return 403; }
      if ($secure_link = "0") { return 410; }

      # ===== PROXY TO REAL STREAM =====
      proxy_pass https://ORIGIN-SERVER/hls/$file;
      proxy_http_version 1.1;

      proxy_set_header Host ORIGIN-SERVER;
      proxy_set_header User-Agent $http_user_agent;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header Range $http_range;

      proxy_buffering off;
      proxy_read_timeout 3600s;

      # HLS MIME
      types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
      }

      add_header Access-Control-Allow-Origin *;
      add_header Cache-Control no-cache;
    }
  }
}
